#!/usr/bin/env bash
set -euo pipefail

version=$(<VERSION)
version=$(echo "$version" | xargs) # Trim whitespace

echo "💎 Build and push gem"
GEM_HOST_API_KEY=$(buildkite-agent secret get RUBYGEMS_API_TOKEN) docker buildx build --secret id=gem-host-api-key,env=GEM_HOST_API_KEY --target gem .

echo "🌈 Checking to see if gem is available"

for i in {1..5}; do
  if gem list --remote buildkite-builder --version "$version" | grep "$version"; then
    echo "✅ buildkite-builder version $version is available on RubyGems."
    break
  else
    echo "⏳ Waiting for buildkite-builder version $version to be available on RubyGems... (attempt $i)"
    sleep 10
  fi
  if [ "$i" -eq 5 ]; then
    echo "❌ Timed out waiting for buildkite-builder version $version to be available on RubyGems." >&2
    exit 1
  fi
done

echo "🐳 Logging in to DockerHub"
buildkite-agent secret get DOCKERHUB_PASSWORD | docker login --username zpadmin --password-stdin

echo "🔨 Building and pushing docker image for release of Buildkite Builder version $version"
docker build --tag=gusto/buildkite-builder:"$version" \
  --target release \
  --platform linux/x86_64 \
  --build-arg version="$version" \
  --push .

echo "✅ Done!"
